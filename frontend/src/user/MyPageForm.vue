<template>
  <div>
    <v-content style="padding: 0px 0px 0px;">
      <v-row no-gutters>
        
        <v-img
          gradient="to top right, rgba(0,0,0,0.8), rgba(0,0,0,0.8)"
          height="900px"
          :src='select_movie_poster'
        >
        <v-row>
          <!-- 영화포스터 -->
          <v-col>
            <v-card
              :loading="loading"
              class="mx-16 my-12"
              max-width="474"
              style="padding-left=50px"
              >
              <template slot="progress">
                <v-progress-linear
                  color="deep-purple"
                  height="10"
                  indeterminate
                ></v-progress-linear>
              </template>

              <v-img
                height="370"
                :src='select_movie_poster'
              ></v-img>

              <v-card-title class="font-weight-black">"{{ username }}"님의 페이지</v-card-title>

              <v-card-text>
                <v-row
                  align="center"
                  class="mx-0"
                >
                </v-row>
                <p class="my-4 h3 font-weight-black">
                  INTRODUCE😎
                </p>

                <p class="font-weight-black">{{ userintroduce }}</p>
              </v-card-text>

              <v-divider class="mx-4"></v-divider>

              <v-card-title class="ma-2 ms-16">🤔Today's My Profile Page Is!!🤔</v-card-title>
                <div class="text-center">
                  <v-menu offset-y>
                    <template v-slot:activator="{ on, attrs }">
                      <v-btn
                        color="primary"
                        dark
                        v-bind="attrs"
                        v-on="on"
                      >
                        Select Poster
                      </v-btn>

                      <v-btn
                        color="danger"
                        dark
                        @click="gotoReview"
                      >
                        Go to Review
                      </v-btn>
                    </template>
                    <v-list>
                      <v-list-item
                        v-for="(movie) in movies"
                        :key="movie.id"
                      >
                        <v-list-item-title 
                          @click="selectMovie($event)" class = "movie-list-item">
                          {{ movie.title }}
                        </v-list-item-title>
                      </v-list-item>
                    </v-list>
                    
                  </v-menu>
                </div>
              <div class="text-center my-3 mb-2">
                💥{{ select_movie }}💥
              </div>
              <br>
            </v-card>
          </v-col>

          <!-- RANK 표현 -->
          <v-col>
            <v-card
              max-width="400"
              class="mx-auto my-12 mr-16"
            >

              <v-container width='1000px'>
                <v-row dense>
                  <v-col cols="12">
                    <v-card
                      color="#385F73"
                      dark
                    >
                      
                    </v-card>
                  </v-col>

                  <v-col
                    v-for="(item, i) in items"
                    :key="i"
                    cols="12"
                  >
                  <v-img :src="item.src"></v-img>
                    <v-card
                      :color="item.color"
                      dark
                      
                    >
                      <div class="d-flex flex-no-wrap justify-space-between">
                        <div>
                          <v-card-title
                            class="text-h5"
                            v-text="item.title"
                          ></v-card-title>

                          <v-card-subtitle v-text="item.artist"></v-card-subtitle>
                          <v-card-subtitle v-if="comments.length<6" >조금 활발히 활동해주세요!</v-card-subtitle>
                          <v-card-subtitle v-else-if="comments.length<11" >쬐끔만 더 힘내봅시다!!</v-card-subtitle>
                          <v-card-subtitle v-else >당신은 댓글VIP!</v-card-subtitle>
                        </div>
                        <v-avatar
                          class="ma-3"
                          size="125"
                          tile
                        >
                        <v-img v-if="comments.length<6" src='@/assets/파이리.png'></v-img>
                        <v-img v-else-if="comments.length<11" src='@/assets/리자드.png'></v-img>
                        <v-img v-else src='@/assets/리자몽.png'></v-img>
                        
                        </v-avatar>
                      </div>
                    </v-card>
                  </v-col>
                </v-row>
              </v-container>
            </v-card>

          <!-- data table 시작 -->
            <v-data-table
              :headers="headers"
              :items="comments"
              class="elevation-1 mx-auto my-12 mr-16 mytable"
              height="450px"
            >
            </v-data-table>
          </v-col>
          </v-row>
        </v-img>
      </v-row>

    </v-content>

  </div>
</template>

<script>
import axios from 'axios'


export default {
  name: 'MyPageForm',
  data() {
    return {
      // 리뷰 등급
      items: [
        {
          color: '#1F7087',
          title: 'My Rank',
        },
      ],
      // data table 시작
      headers: [
        {
          text: 'My Review',
          align: 'start',
          sortable: false,
          value: 'comment_title',
          class: "success--text title "
        },
        { text: 'Content', value: 'content' },
        { text: 'Movie Rating', value: 'rank' },
        { text: 'Created_at', value: 'created_at' },
      ],
      // data table 끝
      comments: [],
      movies: [],
      select_movie: localStorage.getItem('select_movie'),
      select_movie_poster: localStorage.getItem('select_movie_poster'),
      mypage_now_movie_id: localStorage.getItem('mypage_now_movie_id'),

      username: this.$store.state.username,
      userintroduce: this.$store.state.introduce,
    }
  },

  // MyPage에서 내가 작성한 comments를 불러와야 하는데 내가 댓글 단 영화제목, 작성시간도 같이 띄워주고 싶다.
  // 그런데 comments 모델에는 댓글 작성한 movie_id만 있고 movie_title은 없는 상황
  created() {
    // 우선 로그인하면서 저장했던 store.state에서 내 user_id를 가져와서 내가 작성한 댓글의 정보를 가져온다.
    axios.get(`http://localhost:8000/api/v1/movie/${this.$store.state.id}/comment/user`)
      .then((res) => {
        // 그 데이터를 comments에 저장한다.
        this.comments = res.data
        // movie_list에 내가 댓글 단 movie_id를 먼저 넣어준다.
        let movie_list = []
        for (var i=0; i<this.comments.length; i++) {
          movie_list.push(this.comments[i].comment_movie)
        }
        // 댓글이 여러개면 movie_id가 여러개 일 수 있으므로
        // 중복을 없애고 movie_list를 다시 리스트화 하는 작업
        movie_list = [...new Set(movie_list)]

        const movie_info = []  // 내가 작성한 movie정보들을 담을 리스트
        // movie_list (movie_id의 리스트)를 돌면서 정보를 요청, 응답하며 movie_info에 저장해준다.
        movie_list.forEach(function(idx){
          movie_info.push(axios.get(`http://localhost:8000/api/v1/movie/${idx}/`))
        })

        // 2중 for문으로 comments 리스트에 맞는 영화제목 추가하기
        // for문 안에서 get.axios 보내면 비동기적 문제가 생김 그래서 Promise.all로 for문 아래를 시작해야함
        // 위 for문이 axios 모두 완료 되어야만 이하 코드가 실행된다는 느낌의 약속?
        Promise.all(movie_info)
        .then((res) => {
          for (let a=0; a<res.length; a++) {
            this.movies.push(res[a].data)
            
            for (let b=0; b<this.comments.length; b++) {
              // created_at도 뒤에 그냥 자르고 날짜만 보이도록 슬라이싱
              this.comments[b].created_at = this.comments[b].created_at.slice(0,10)
              // 만약 원하는 data를 찾았다면
              if (res[a].data.id === this.comments[b].comment_movie) {
              // comments에 'comment_title'이란 dict의 key느낌 친구 만들고 value 저장
                this.comments[b]['comment_title'] = res[a].data.title
              }
            }
          }
        })
      })
      .catch(error => console.log(error))


  },
  methods: {
    gotoReview() {
      localStorage.setItem('select_review_movie', this.select_movie)
      localStorage.setItem('select_review_movie_poster', this.select_movie_poster)
      localStorage.setItem('now_movie_id', this.mypage_now_movie_id)
      this.$router.push('/community')
    },
    selectMovie() {
      const myMovie = event.target.innerText
      this.select_movie = myMovie
      localStorage.setItem('select_movie', this.select_movie)
        this.movies.forEach( (movie) =>  {
          if (myMovie === movie.title) {
            this.select_movie_poster = movie.poster_path
            localStorage.setItem('select_movie_poster', movie.poster_path)
            this.mypage_now_movie_id = movie.id
            localStorage.setItem('mypage_now_movie_id', movie.id)
          }
        })
      },
    },
  }

</script>

<style>
.movie-list-item:hover { 
  /* hover 어떤 요소를 마우스로 갖다 대는 것! */
  cursor: pointer;
  background-color: #eee; 
  /* 갖다대면 커서를 바꿈! */
}

/* 왜 폰트만 바뀌지 ? */
.mytable {
  font-family: Montserrat-Medium;
  font-size: 36px;
  text-transform: uppercase;
  color: rgb(230, 39, 39);
  line-height: 1.4;
  background-color: black;
}
</style>